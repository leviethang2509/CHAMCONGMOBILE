<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Báo Cáo Chấm Công</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>

<body>
<style>
    .pagination {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #ffffff;
    padding: 12px 16px;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    margin-top: 20px;
}

.pagination button {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: white;
    border: none;
    padding: 8px 18px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
}

.pagination button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(37, 99, 235, 0.3);
}

</style>
<div class="app">

    <!-- HEADER -->
    <div class="header">
        <h2>Báo Cáo Tháng 02/2026</h2>
        <div style="margin-top:6px;font-size:14px;">Thống kê chấm công theo ngày</div>
    </div>

    <!-- FILTER -->
   <select id="monthFilter"></select>

    <!-- GRID -->
    <div class="report-grid">

        <div class="grid-header">
            <div>Ngày</div>
            <div>Vào</div>
            <div>Ra</div>
            <div>Tổng</div>
        </div>

      
    </div>

    <!-- SUMMARY -->
    <div class="report-summary">
        <div>Tổng ngày công: <strong></strong></div>
        <div>Tổng giờ làm: <strong></strong></div>
    </div>
<div class="pagination" id="pagination">
    <button onclick="prevPage()">◀ Trước</button>
    <span id="pageInfo"></span>
    <button onclick="nextPage()">Sau ▶</button>
</div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
        <div class="active" onclick="location.href='home.html'">Trang chủ</div>
        <div onclick="location.href='history.html'">Lịch sử</div>
        <div onclick="location.href='report.html'">Báo cáo</div>
        <!-- <div>Cá nhân</div> -->
    </div>

</div>
<script src="./appsetting.js"></script>
<script>

let currentPage = 1;
const pageSize = 10;
let currentData = [];

/* ==============================
   TÍNH GIỜ
================================= */
function tinhSoGio(gioVao, gioRa) {

    if (!gioVao || !gioRa) return null;

    const [vaoH, vaoM] = gioVao.split(":").map(Number);
    const [raH, raM] = gioRa.split(":").map(Number);

    let vaoPhut = vaoH * 60 + vaoM;
    let raPhut = raH * 60 + raM;

    if (raPhut < vaoPhut) raPhut += 24 * 60;

    const tongPhut = raPhut - vaoPhut;

    return {
        gio: Math.floor(tongPhut / 60),
        phut: tongPhut % 60,
        tongPhut
    };
}

/* ==============================
   DROPDOWN 12 THÁNG
================================= */
function taoDropdown12Thang() {

    const select = document.getElementById("monthFilter");
    select.innerHTML = "";

    const nam = new Date().getFullYear();

    for (let i = 1; i <= 12; i++) {

        const thang = String(i).padStart(2,'0');
        const value = `${nam}-${thang}`;

        const option = document.createElement("option");
        option.value = value;
        option.textContent = `Tháng ${thang}/${nam}`;

        select.appendChild(option);
    }

    select.value = getThangNamHienTai();
}

/* ==============================
   LOAD BÁO CÁO
================================= */
async function loadBaoCao(thangNamChon) {

    currentPage = 1;

    const grid = document.querySelector(".report-grid");

    try {

        const res = await fetch(BASE_URL);
        const data = await res.json();

        const record = data.find(x => x.Thang === thangNamChon);

        grid.querySelectorAll(".grid-row").forEach(e => e.remove());

        if (!record || !record.GioVao_GioRa_Thang?.length) {
            updateSummary(0,0);
            currentData = [];
            updatePagination();
            return;
        }

        const [year, month] = thangNamChon.split("-");
        document.querySelector(".header h2").innerText =
            `Báo Cáo Tháng ${month}/${year}`;

        currentData = [...record.GioVao_GioRa_Thang]
            .sort((a, b) => new Date(a.idNgay) - new Date(b.idNgay));

        renderPage();

    } catch (err) {
        console.error("Lỗi tải báo cáo:", err);
    }
}

/* ==============================
   RENDER TRANG
================================= */
function renderPage() {

    const grid = document.querySelector(".report-grid");

    grid.querySelectorAll(".grid-row").forEach(e => e.remove());

    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;

    const pageData = currentData.slice(start, end);

    pageData.forEach(ngay => {

        const ngaySo = new Date(ngay.idNgay).getDate();
        const gioVao = ngay.GioVao ?? "--";
        const gioRa = ngay.GioRa ?? "--";

        const ketQua = tinhSoGio(ngay.GioVao, ngay.GioRa);

        let tongText = "Nghỉ";
        let colorClass = "red";

        if (ketQua) {
            tongText = `${ketQua.gio} giờ ${ketQua.phut} phút`;
            colorClass = ketQua.tongPhut >= 8 * 60 ? "green" : "yellow";
        }

        const row = `
            <div class="grid-row">
                <div>${String(ngaySo).padStart(2,'0')}</div>
                <div>${gioVao}</div>
                <div>${gioRa}</div>
                <div class="${colorClass}">${tongText}</div>
            </div>
        `;

        grid.insertAdjacentHTML("beforeend", row);
    });

    tinhTongThang();
    updatePagination();
}

/* ==============================
   TÍNH TỔNG TOÀN THÁNG
================================= */
function tinhTongThang() {

    let tongPhutThang = 0;

    currentData.forEach(ngay => {

        const ketQua = tinhSoGio(ngay.GioVao, ngay.GioRa);

        if (ketQua) {
            tongPhutThang += ketQua.tongPhut;
        }
    });

    // 1 công = 8 giờ = 480 phút
    const tongNgayCong = tongPhutThang / (8 * 60);

    updateSummary(
        parseFloat(tongNgayCong.toFixed(2)), 
        tongPhutThang
    );
}

function updateSummary(ngayCong, tongPhut) {

    const gio = Math.floor(tongPhut / 60);
    const phut = tongPhut % 60;

    document.querySelector(".report-summary").innerHTML = `
        <div>Tổng ngày công: <strong>${ngayCong}</strong></div>
        <div>Tổng giờ làm: <strong>${gio} giờ ${phut} phút</strong></div>
    `;
}

/* ==============================
   PHÂN TRANG
================================= */
function updatePagination() {

    const totalPages = Math.ceil(currentData.length / pageSize) || 1;

    document.getElementById("pageInfo").innerText =
        `Trang ${currentPage} / ${totalPages}`;

    document.querySelector("#pagination button:first-child").disabled = currentPage === 1;
    document.querySelector("#pagination button:last-child").disabled = currentPage === totalPages;
}

function nextPage() {
    const totalPages = Math.ceil(currentData.length / pageSize);
    if (currentPage < totalPages) {
        currentPage++;
        renderPage();
    }
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        renderPage();
    }
}

/* ==============================
   TIỆN ÍCH
================================= */
function getThangNamHienTai() {
    const now = new Date();
    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2,'0')}`;
}

/* ==============================
   EVENT
================================= */
document.addEventListener("DOMContentLoaded", () => {

    taoDropdown12Thang();

    const thangMacDinh = getThangNamHienTai();
    loadBaoCao(thangMacDinh);

    document.getElementById("monthFilter")
        .addEventListener("change", function () {
            loadBaoCao(this.value);
        });
});

</script>
</body>
</html>
