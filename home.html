<!DOCTYPE html>
<html lang="vi">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
    .avatar {
    width: 60px;
    height: 60px;
    background: #0d6efd;
    color: white;
    border-radius: 50%;
    font-size: 28px;
}

</style>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trang Ch·ªß - Ch·∫•m C√¥ng</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

</head>
<body>

<div class="app">

    <div class="header">
        <div class="user">
            <div class="avatar icon d-flex justify-content-center align-items-center">
                <i class="bi bi-person-fill"></i>
            </div>
            <div>
                <div><strong>L√™ B·∫°ch V√¢n</strong></div>
                <div id="today"></div>
            </div>
        </div>
        <div class="status green">‚óè ƒê√£ ch·∫•m c√¥ng</div>
    </div>

    <div class="card">
        <div class="time-row">
            <div>Ch·∫•m v√†o</div>
            <div><strong id="gioVao">--:--</strong></div>
        </div>
        <div class="time-row">
            <div>Ch·∫•m ra</div>
            <div id="gioRa">--:--</div>
        </div>
        <div class="total" id="tongGio"></div>
    </div>

    <div class="btn btn-red" onclick="chamCong()">CH·∫§M C√îNG</div>

    <div class="map-section">
        <div class="map-title">üìç X√°c nh·∫≠n v·ªã tr√≠ hi·ªán t·∫°i</div>
        <div id="map" style="height:180px;border-radius:16px;"></div>
        <div class="location-text" id="locationText">
            ƒêang x√°c ƒë·ªãnh v·ªã tr√≠...
        </div>
    </div>
    <div class="bottom-nav">
        <div class="active" onclick="location.href='home.html'">Trang ch·ªß</div>
        <div onclick="location.href='history.html'">L·ªãch s·ª≠</div>
        <div onclick="location.href='report.html'">B√°o c√°o</div>
        <!-- <div>C√° nh√¢n</div> -->
    </div>
</div>

<script>
const userId = null;
// ========================
// HI·ªÇN TH·ªä NG√ÄY H√îM NAY
// ========================
  window.onload = function () { 

       loadChamCong();
       userId = localStorage.getItem("TaiKhoanId");

    if(!userId){
        window.location.href="index.html";
    }

}
function getGioHienTai() {
    const now = new Date();
    return now.getHours().toString().padStart(2,'0') + ":" +
           now.getMinutes().toString().padStart(2,'0');
}
document.getElementById("today").innerText =
    new Date().toLocaleDateString("vi-VN", {
        weekday: "long",
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
    });

// ========================
// LEAFLET MAP
// ========================

let currentLat = null;
let currentLng = null;

function initLeafletMap(lat, lng) {

    const map = L.map('map').setView([lat, lng], 16);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    L.marker([lat, lng]).addTo(map)
        .bindPopup("B·∫°n ƒëang ·ªü ƒë√¢y")
        .openPopup();
}

function getLocation() {

    if (!navigator.geolocation) {
        document.getElementById("locationText").innerHTML =
            "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS.";
        return;
    }

    navigator.geolocation.getCurrentPosition(
        function(position) {

            currentLat = position.coords.latitude;
            currentLng = position.coords.longitude;

            initLeafletMap(currentLat, currentLng);

            document.getElementById("locationText").innerHTML =
                "Lat: " + currentLat.toFixed(5) +
                " | Lng: " + currentLng.toFixed(5);
        },
        function() {
            document.getElementById("locationText").innerHTML =
                "Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠.";
        },
        { enableHighAccuracy: true }
    );
}

getLocation();

// ========================
// MOCK API
// ========================

const Id = Math.random();
function tinhSoGio(gioVao, gioRa) {

    if (!gioVao || !gioRa) return 0;

    const [vaoH, vaoM] = gioVao.split(":").map(Number);
    const [raH, raM] = gioRa.split(":").map(Number);

    let tongPhut = (raH * 60 + raM) - (vaoH * 60 + vaoM);

    // N·∫øu l√†m qua ng√†y (vd 22:00 -> 06:00)
    if (tongPhut < 0) {
        tongPhut += 24 * 60;
    }

    const gio = Math.floor(tongPhut / 60);
    const phut = tongPhut % 60;

    // Hi·ªÉn th·ªã UI
    document.getElementById("tongGio").innerText =
        `T·ªïng gi·ªù: ${gio}h ${phut}p`;

    return {
        gio,
        phut,
        tongPhut
    };
}


function getHomNay() {
    const today = new Date();
    today.setDate(today.getDate() + 2); // +1 ng√†y
    return today.toISOString().split("T")[0];
}
async function chamCong() {

    const homNay = getHomNay();
    const gioHienTai = getGioHienTai();

    const now = new Date();
    const nam = now.getFullYear();
    const thang = String(now.getMonth() + 1).padStart(2, "0");
    const thangNam = `${nam}-${thang}`;
   
    try {

        // =========================
        // 1Ô∏è‚É£ L·∫§Y TO√ÄN B·ªò DANH S√ÅCH
        // =========================

        let res = await fetch(BASE_URL);
        let allData = await res.json();

        // T√¨m th√°ng hi·ªán t·∫°i
        let record = allData.find(x => x.Thang === thangNam);

        // =========================
        // 2Ô∏è‚É£ N·∫æU CH∆ØA C√ì TH√ÅNG ‚Üí T·∫†O M·ªöI
        // =========================

        if (!record) {

            const createRes = await fetch(BASE_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    Thang: thangNam,
                    GioVao_GioRa_Thang: []
                })
            });

            record = await createRes.json();
        }

        let danhSachThang = Array.isArray(record.GioVao_GioRa_Thang)
            ? record.GioVao_GioRa_Thang
            : [];

        // =========================
        // 3Ô∏è‚É£ X·ª¨ L√ù NG√ÄY
        // =========================

        let ngay = danhSachThang.find(x => x.idNgay === homNay);
        
        if (!ngay) {

            // CHECK IN
            danhSachThang.push({
                idNgay: homNay,
                GioVao: gioHienTai,
                GioRa: null,
                IsTangCa: false,
                SoTieng_TrongNgay: 0
            });

            document.getElementById("gioVao").innerText = gioHienTai;

        }
        else if (!ngay.GioRa) {
            const soGio  = getHomNay(ngay.GioVao ?? null ,ngay.GioRa ?? null);
            // CHECK OUT
            ngay.GioRa = gioHienTai;
            ngay.SoTieng_TrongNgay = Number(soGio);
            ngay.IsTangCa = soGio > 8;
            ngay.SoTieng_TrongNgay = tinhSoGio(ngay.GioVao,ngay.GioRa);
        }
        else
        {
            const soGio  = getHomNay(ngay.GioVao ?? null ,ngay.GioRa ?? null);
              // CHECK OUT
            ngay.GioRa = gioHienTai;
            ngay.SoTieng_TrongNgay = Number(soGio);
            ngay.IsTangCa = soGio > 8;
            ngay.SoTieng_TrongNgay = tinhSoGio(ngay.GioVao,ngay.GioRa);
        }
        // =========================
        // 4Ô∏è‚É£ UPDATE L·∫†I THEO ID TH·∫¨T
        // =========================

        await fetch(`${BASE_URL}/${record.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                ...record,
                GioVao_GioRa_Thang: danhSachThang
            })
        });

        alert("L∆∞u th√†nh c√¥ng ‚úÖ");
        loadChamCong();

    } catch (err) {
        console.error(err);
        alert("L·ªói h·ªá th·ªëng ‚ùå");
    }
}

function getThangNamHienTai() {
    const now = new Date();
    const nam = now.getFullYear();
    const thang = String(now.getMonth() + 1).padStart(2, "0");
    return `${nam}-${thang}`;
}
async function loadChamCong() {

    const thangNam = getThangNamHienTai();
    const homNay = getHomNay();

    try {

        const res = await fetch(BASE_URL);
        const data = await res.json();

        const record = data.find(x => x.Thang === thangNam);

        if (!record) return;

        const ngay = record.GioVao_GioRa_Thang
            ?.find(x => x.idNgay === homNay);

        // Hi·ªÉn th·ªã ng√†y h√¥m nay
        document.getElementById("today").innerText = homNay;

        if (!ngay) {
            // Ch∆∞a ch·∫•m c√¥ng
            document.getElementById("gioVao").innerText = "--:--";
            document.getElementById("gioRa").innerText = "--:--";
            document.getElementById("tongGio").innerText = "T·ªïng gi·ªù: 0h";

            setStatus(false);
            return;
        }

        // C√≥ d·ªØ li·ªáu
        document.getElementById("gioVao").innerText =
            ngay.GioVao ?? "--:--";

        document.getElementById("gioRa").innerText =
            ngay.GioRa ?? "--:--";

        document.getElementById("tongGio").innerText =
            "T·ªïng gi·ªù: " + (ngay.SoTieng_TrongNgay.gio ?? 0) + " gi·ªù " + (ngay.SoTieng_TrongNgay.phut ?? 0) + " ph√∫t ";

        // N·∫øu ƒë√£ c√≥ gi·ªù ra => ƒë√£ ch·∫•m c√¥ng
        setStatus(!!ngay.GioRa);

    } catch (err) {
        console.error(err);
    }
}
function setStatus(isDone) {

    const statusDiv = document.querySelector(".status");

    if (isDone) {
        statusDiv.classList.remove("red");
        statusDiv.classList.add("green");
        statusDiv.innerHTML = "‚óè ƒê√£ ch·∫•m c√¥ng";
    } else {
        statusDiv.classList.remove("green");
        statusDiv.classList.add("red");
        statusDiv.innerHTML = "‚óè Ch∆∞a ch·∫•m c√¥ng";
    }
}

</script>
<script src="./appsetting.js"></script>
</body>
</html>
